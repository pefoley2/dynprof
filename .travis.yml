language: cpp
sudo: required
# we need a newer cmake
dist: trusty
compiler:
    - clang
    - gcc
env:
    - DYNINST=DyninstAPI-9.1.0 DYNINSTAPI_RT_LIB=$HOME/dyninst/lib/libdyninstAPI_RT.so
cache:
    apt: true
    directories:
        - $HOME/dyninst
before_install:
    - sudo apt-get -qq update
    - sudo apt-get -y install libiberty-dev libboost-all-dev libelf-dev
    - test -d $HOME/dyninst/include || wget -N http://www.paradyn.org/release9.1.0/$DYNINST.tgz
    - test -d $HOME/dyninst/include || tar xf $DYNINST.tgz
install:
    - test -d $HOME/dyninst/include || (mkdir -p $DYNINST/work && cd $DYNINST/work && cmake .. -DCMAKE_INSTALL_PREFIX=$HOME/dyninst -DCMAKE_C_COMPILER=gcc -DCMAKE_CXX_COMPILER=g++ -DUSE_GNU_DEMANGLER=1)
    - test -d $HOME/dyninst/include || make -C $DYNINST/work install
script:
    - CFLAGS="-Werror -isystem $HOME/dyninst/include" LDFLAGS="-L$HOME/dyninst/lib" LD_LIBRARY_PATH=$HOME/dyninst/lib make binary test
    - ./test_dynprof
